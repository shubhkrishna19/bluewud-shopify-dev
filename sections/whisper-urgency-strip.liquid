{% schema %}
{
  "name": "Urgency Strip",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_urgency",
      "label": "Enable Urgency Strip",
      "default": true
    },
    {
      "type": "text",
      "id": "badge_text",
      "label": "Badge Text",
      "default": "ENDING SOON"
    },
    {
      "type": "text",
      "id": "sale_text",
      "label": "Sale Text",
      "default": "Republic Day Sale: Flat 55% Off + Extra 20% Off"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#FFF4E6"
    }
  ],
  "presets": [
    {
      "name": "Urgency Strip",
      "category": "Promotional"
    }
  ]
}
{% endschema %}

{% if section.settings.enable_urgency %}
<div class="whisper-urgency-strip" style="background-color: {{ section.settings.bg_color }};">
  <div class="page-width">
    <div class="urgency-content">
      <div class="urgency-text">
        <span class="urgency-badge">{{ section.settings.badge_text }}</span>
        <span class="urgency-label">{{ section.settings.sale_text }}</span>
      </div>
      <div class="urgency-timer">
        <span class="timer-block" id="urgency-hours-{{ section.id }}">04</span>
        <span class="timer-colon">:</span>
        <span class="timer-block" id="urgency-minutes-{{ section.id }}">12</span>
        <span class="timer-colon">:</span>
        <span class="timer-block" id="urgency-seconds-{{ section.id }}">45</span>
      </div>
    </div>
  </div>
</div>



<script>
  document.addEventListener('DOMContentLoaded', function() {
    const INITIAL_SECONDS = 4 * 3600 + 30 * 60; 
    let remaining = INITIAL_SECONDS;
    const key = 'whisper_urgency_end';

    // Check localStorage
    const savedTime = localStorage.getItem(key);
    const now = Date.now();

    if (savedTime && parseInt(savedTime) > now) {
      remaining = Math.floor((parseInt(savedTime) - now) / 1000);
    } else {
      localStorage.setItem(key, now + (INITIAL_SECONDS * 1000));
    }

    const els = {
      h: document.getElementById('urgency-hours-{{ section.id }}'),
      m: document.getElementById('urgency-minutes-{{ section.id }}'),
      s: document.getElementById('urgency-seconds-{{ section.id }}')
    };

    function update() {
      if (remaining <= 0) {
        remaining = 14400; // Reset loop
        localStorage.setItem(key, Date.now() + (remaining * 1000));
      }

      remaining--;

      const h = Math.floor(remaining / 3600);
      const m = Math.floor((remaining % 3600) / 60);
      const s = remaining % 60;

      if(els.h) els.h.textContent = h.toString().padStart(2, '0');
      if(els.m) els.m.textContent = m.toString().padStart(2, '0');
      if(els.s) els.s.textContent = s.toString().padStart(2, '0');
    }

    setInterval(update, 1000);
    update();
  });
</script>
{% endif %}
