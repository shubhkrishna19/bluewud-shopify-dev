<div class="whisper-reviews-section space-y-6 animate-fade-in-up" id="whisper-reviews-root">
  <!-- Actions & Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b-2 border-[var(--color-border-primary)]">
    <h3 class="text-xl font-black uppercase tracking-wider text-[var(--color-text-primary)]">
      Customer Reviews
    </h3>
    <div class="flex gap-3 w-full sm:w-auto">
      <select id="whisper-reviews-sort" class="px-4 py-2 border-2 border-[var(--color-border-primary)] rounded-lg text-sm font-semibold bg-[var(--color-bg-primary)] text-[var(--color-text-primary)] focus:ring-2 focus:ring-[var(--color-accent-primary)]">
        <option value="newest">Newest First</option>
        <option value="highest">Highest Rated</option>
        <option value="lowest">Lowest Rated</option>
        <option value="helpful">Most Helpful</option>
      </select>
      <button class="whisper-button whisper-button--primary flex-1 sm:flex-none">
        Write a Review
      </button>
    </div>
  </div>

  <!-- Reviews List Container -->
  <div id="whisper-reviews-list" class="space-y-6">
    {% comment %} Content populated via JS for sorting performance {% endcomment %}
    <div class="flex justify-center py-12">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--color-accent-primary)]"></div>
    </div>
  </div>

  <script>
    (function() {
      // Mock data if metafield is empty for demo parity
      const mockReviews = [
        {
          _id: "r1",
          userName: "Alex R.",
          rating: 5,
          title: "Exceptional Build Quality",
          comment: "The finish on this engineered wood is better than most solid wood pieces I've seen. Putting it together was a breeze with the clear instructions provided.",
          createdAt: new Date().getTime() - 86400000 * 2,
          verifiedPurchase: true,
          helpfulCount: 24
        },
        {
          _id: "r2",
          userName: "Sarah M.",
          rating: 4,
          title: "Great Space Saver",
          comment: "Perfect for my small studio apartment. The smart storage compartments really help in keeping things organized without taking up much floor space.",
          createdAt: new Date().getTime() - 86400000 * 5,
          verifiedPurchase: true,
          helpfulCount: 15
        },
        {
          _id: "r3",
          userName: "Vikram S.",
          rating: 5,
          title: "Stunning Design",
          comment: "It looks even better in person. The minimal aesthetic fits perfectly with my modern decor. Definitely worth every rupee.",
          createdAt: new Date().getTime() - 86400000 * 10,
          verifiedPurchase: true,
          helpfulCount: 42
        }
      ];

      const rawData = {{ product.metafields.custom.reviews.value | json }};
      let reviews = (rawData && rawData.length > 0) ? rawData : mockReviews;

      const listContainer = document.getElementById('whisper-reviews-list');
      const sortSelect = document.getElementById('whisper-reviews-sort');

      function renderStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
          stars += `
            <svg class="w-3.5 h-3.5 ${i <= rating ? 'text-[#F59E0B]' : 'text-[var(--color-text-tertiary)]'} fill-current" viewBox="0 0 20 20">
              <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" />
            </svg>
          `;
        }
        return stars;
      }

      function renderReviews() {
        if (!reviews || reviews.length === 0) {
          listContainer.innerHTML = `
            <div class="text-center py-16 bg-[var(--color-bg-secondary)] rounded-lg border-2 border-dashed border-[var(--color-border-primary)]">
              <svg class="w-12 h-12 text-[var(--color-text-tertiary)] mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
              <p class="text-[var(--color-text-secondary)] font-bold">No reviews yet.</p>
              <p class="text-xs text-[var(--color-text-tertiary)] mt-1">Be the first to share your experience!</p>
            </div>
          `;
          return;
        }

        listContainer.innerHTML = reviews.map(review => `
          <div class="p-8 bg-[var(--color-bg-primary)] rounded-lg border-2 border-[var(--color-border-primary)] shadow-sm hover:shadow-md transition-all duration-300">
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-14 h-14 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white font-extrabold text-xl shadow-sm">
                  ${review.userName.charAt(0).toUpperCase()}
                </div>
                <div>
                  <div class="flex items-center gap-2">
                    <span class="font-bold text-[var(--color-text-primary)]">${review.userName}</span>
                    ${review.verifiedPurchase ? `
                      <span class="px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-[10px] font-bold uppercase rounded-full tracking-wider">
                        Verified Purchase
                      </span>
                    ` : ''}
                  </div>
                  <div class="flex items-center gap-2 mt-1">
                    <div class="flex gap-0.5">${renderStars(review.rating)}</div>
                    <span class="text-[10px] text-[var(--color-text-tertiary)] font-bold uppercase">
                      ${new Date(review.createdAt).toLocaleDateString()}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            ${review.title ? `<h5 class="font-bold text-[var(--color-text-primary)] mb-2 text-lg">${review.title}</h5>` : ''}
            <p class="text-[var(--color-text-secondary)] leading-relaxed mb-4 text-sm font-medium">${review.comment}</p>

            <div class="flex items-center gap-4">
              <button onclick="window.whisperHelpful('${review._id}')" class="flex items-center gap-1.5 text-xs font-bold uppercase tracking-wider text-[var(--color-text-tertiary)] hover:text-[var(--color-accent-primary)] transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                </svg>
                Helpful (<span id="helpful-${review._id}">${review.helpfulCount || 0}</span>)
              </button>
            </div>
          </div>
        `).join('');
      }

      function sortReviews() {
        const val = sortSelect.value;
        if (val === 'newest') reviews.sort((a, b) => b.createdAt - a.createdAt);
        else if (val === 'highest') reviews.sort((a, b) => b.rating - a.rating);
        else if (val === 'lowest') reviews.sort((a, b) => a.rating - b.rating);
        else if (val === 'helpful') reviews.sort((a, b) => b.helpfulCount - a.helpfulCount);
        renderReviews();
      }

      window.whisperHelpful = function(id) {
        const review = reviews.find(r => r._id === id);
        if (review) {
          review.helpfulCount = (review.helpfulCount || 0) + 1;
          const el = document.getElementById(`helpful-${id}`);
          if (el) el.innerText = review.helpfulCount;
          // Local persistence for session parity
          localStorage.setItem(`helpful_${id}`, review.helpfulCount);
        }
      };

      // Handle session persistence
      reviews.forEach(r => {
        const saved = localStorage.getItem(`helpful_${r._id}`);
        if (saved) r.helpfulCount = parseInt(saved);
      });

      sortSelect.addEventListener('change', sortReviews);
      sortReviews(); // Initial sort
    })();
  </script>
</div>
