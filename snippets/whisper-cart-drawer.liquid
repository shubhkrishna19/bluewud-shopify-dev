{% comment %}
  Whisper Cart Drawer
  Mirrored from Cart.tsx (ecommerce-app)
{% endcomment %}

<div id="whisper-cart-drawer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;">
  <!-- Overlay -->
  <div class="whisper-drawer-overlay" onclick="window.whisperCart.close()" style="position: absolute; inset: 0; background: rgba(0,0,0,0.5);"></div>
  
  <!-- Drawer Content -->
  <div class="whisper-drawer-content" style="position: absolute; top: 0; right: 0; width: 100%; max-width: 420px; height: 100%; background: #ffffff; display: flex; flex-direction: column;">
    <!-- Header -->
    <div class="p-6 border-b-2 border-[var(--color-border-primary)] flex justify-between items-center bg-[var(--color-bg-secondary)]">
      <h2 class="text-2xl font-black uppercase tracking-tighter italic text-[var(--color-text-primary)]">
        Your Cart <span class="text-sm font-normal not-italic text-[var(--color-text-tertiary)] ml-2" id="whisper-cart-count-header">({{ cart.item_count }})</span>
      </h2>
      <button class="p-2 hover:bg-black/5 rounded-full transition-colors" onclick="window.whisperCart.close()">
        <svg class="w-6 h-6 text-[var(--color-text-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Free Shipping Progress -->
    <div class="p-6 bg-gradient-to-r from-blue-600/10 to-cyan-500/10 border-b-2 border-[var(--color-border-primary)]" id="whisper-cart-shipping-bar">
      {%- assign threshold = 500000 -%} {% comment %} 5000 in cents {% endcomment %}
      {%- assign total = cart.total_price -%}
      {%- assign remaining = threshold | minus: total -%}
      {%- assign progress = total | times: 100.0 | divided_by: threshold | at_most: 100 -%}
      
      <div class="flex justify-between text-xs font-black uppercase tracking-widest mb-3">
        {% if total >= threshold %}
          <span class="text-green-600 flex items-center gap-2">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
            Unlocked FREE Shipping!
          </span>
        {% else %}
          <span class="text-[var(--color-text-secondary)]">
            Add <span class="text-[var(--color-text-primary)]">{{ remaining | money }}</span> more for <span class="text-blue-600">FREE SHIPPING</span>
          </span>
        {% endif %}
        <span class="text-[var(--color-text-tertiary)]">{{ progress | round }}%</span>
      </div>
      <div class="h-2 bg-[var(--color-border-primary)] rounded-full overflow-hidden">
        <div class="h-full bg-gradient-to-r from-blue-600 to-cyan-500 transition-all duration-700 ease-out rounded-full" style="width: {{ progress }}%"></div>
      </div>
    </div>

    <!-- Items List -->
    <div class="flex-1 overflow-y-auto p-6 space-y-6" id="whisper-cart-items">
      {% if cart.item_count > 0 %}
        {% for item in cart.items %}
          <div class="flex gap-4 group/item animate-fade-in-up" style="animation-delay: {{ forloop.index | times: 100 }}ms;">
            <div class="w-24 h-24 bg-[var(--color-bg-secondary)] rounded-lg border-2 border-[var(--color-border-primary)] overflow-hidden flex-shrink-0">
              <img src="{{ item.image | img_url: '200x' }}" alt="{{ item.title }}" class="w-full h-full object-cover group-hover/item:scale-110 transition-transform duration-500">
            </div>
            <div class="flex-1 flex flex-col justify-between py-1">
              <div>
                <h3 class="text-sm font-black text-[var(--color-text-primary)] leading-tight uppercase tracking-tight line-clamp-2">
                  {{ item.product.title }}
                </h3>
                <p class="text-[10px] font-bold text-[var(--color-text-tertiary)] mt-1 uppercase">
                  {{ item.variant.title | remove: 'Default Title' }}
                </p>
                <p class="text-sm font-black text-[var(--color-accent-primary)] mt-1">
                  {{ item.final_price | money }}
                </p>
              </div>
              
              <div class="flex items-center justify-between">
                <div class="flex items-center border-2 border-[var(--color-border-primary)] rounded-md">
                  <button class="px-2 py-1 text-xs hover:bg-[var(--color-bg-secondary)]" onclick="window.whisperCart.update('{{ item.key }}', {{ item.quantity | minus: 1 }})">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 12H4"/></svg>
                  </button>
                  <span class="px-3 text-xs font-black">{{ item.quantity }}</span>
                  <button class="px-2 py-1 text-xs hover:bg-[var(--color-bg-secondary)]" onclick="window.whisperCart.update('{{ item.key }}', {{ item.quantity | plus: 1 }})">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                  </button>
                </div>
                <button class="text-[10px] font-black uppercase tracking-widest text-red-500 hover:text-red-600 transition-colors" onclick="window.whisperCart.update('{{ item.key }}', 0)">
                  Remove
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="h-full flex flex-col items-center justify-center text-center py-20">
          <svg class="w-20 h-20 text-[var(--color-border-primary)] mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          <h3 class="text-xl font-black text-[var(--color-text-primary)] uppercase italic">Your cart is empty</h3>
          <p class="text-sm text-[var(--color-text-tertiary)] mt-2 font-medium">Add some items to get started!</p>
          <a href="/collections/all" class="mt-8 px-10 py-4 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-lg font-black uppercase tracking-widest text-sm shadow-xl hover:shadow-cyan-500/20 transition-all">
            Shop Catalog
          </a>
        </div>
      {% endif %}
    </div>

    <!-- Footer -->
    {% if cart.item_count > 0 %}
      <div class="p-6 bg-[var(--color-bg-secondary)] border-t-2 border-[var(--color-border-primary)] space-y-4">
        {% render 'coupon-applier' %}
        <div class="flex justify-between items-end">
          <span class="text-xs font-black uppercase tracking-widest text-[var(--color-text-tertiary)]">Subtotal</span>
          <span class="text-3xl font-black italic tracking-tighter text-[var(--color-text-primary)]">{{ cart.total_price | money }}</span>
        </div>
        <p class="text-[10px] text-[var(--color-text-tertiary)] font-bold uppercase text-center py-2">
          Shipping & taxes calculated at checkout
        </p>
        <form action="/checkout" method="post" class="space-y-3">
          <button type="submit" name="checkout" class="w-full py-5 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-lg font-black uppercase tracking-[0.2em] text-lg shadow-xl hover:shadow-cyan-500/30 transition-all transform hover:scale-[1.02] active:scale-95">
            Checkout Now
          </button>
          <a href="/cart" class="block w-full text-center py-3 text-xs font-black uppercase tracking-widest text-[var(--color-text-primary)] border-2 border-[var(--color-border-primary)] rounded-lg hover:bg-white/5 transition-colors">
            View Full Cart
          </a>
        </form>
      </div>
    {% endif %}
  </div>
</div>

<script>
  window.whisperCart = {
    open: function() {
      var drawer = document.getElementById('whisper-cart-drawer');
      drawer.style.display = 'block';
      // Small timeout to allow display change to register before animating visibility
      setTimeout(() => {
        drawer.classList.add('is-open');
      }, 10);
      document.body.classList.add('overflow-hidden');
    },
    close: function() {
      var drawer = document.getElementById('whisper-cart-drawer');
      drawer.classList.remove('is-open');
      document.body.classList.remove('overflow-hidden');
      // Wait for transitions to finish before hiding
      setTimeout(() => {
        drawer.style.display = 'none';
      }, 300);
    },
    update: function(key, qty) {
      document.getElementById('whisper-cart-drawer').classList.add('opacity-50', 'pointer-events-none');
      fetch('/cart/change.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: key, quantity: qty })
      })
      .then(r => r.json())
      .then(cart => {
        // Simple reload for demo, but could be dynamic
        window.location.reload();
      });
    }
  };

  // Intercept Shopify ATC if needed or provide trigger
  document.addEventListener('shopify:cart:added', () => {
    window.whisperCart.open();
  });
</script>

<style>
  #whisper-cart-drawer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  #whisper-cart-drawer.is-open {
    visibility: visible;
    opacity: 1;
    pointer-events: auto;
  }

  /* Ensure the inner drawer transforms correctly */
  #whisper-cart-drawer > div:last-child {
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  #whisper-cart-drawer.is-open > div:last-child {
    transform: translateX(0);
  }
</style>
