<script
  type="module"
  src="{{ 'cart-icon.js' | asset_url }}"
  fetchpriority="low"
></script>

{% capture cart_icon %}
  <cart-icon
    class="
      header-actions__cart-icon
      {% unless cart == empty %} header-actions__cart-icon--has-cart{% endunless %}
    "
    data-testid="cart-icon"
  >
    <span
      class="svg-wrapper"
      aria-hidden="true"
    >
      {{ 'icon-cart.svg' | inline_asset_content }}
    </span>

    {% render 'whisper-cart-bubble', limit: 100, live_region: true, test_id: test_id %}
  </cart-icon>
{% endcapture %}

<header-actions
  {{- block.shopify_attributes -}}
>
  {% if shop.customer_accounts_enabled %}
    <script
      src="{{ 'dialog.js' | asset_url }}"
      type="module"
    ></script>

    <anchored-popover-component
      data-close-on-resize="true"
      class="account-popover mobile:hidden"
    >
      {% render 'whisper-account-button' with 'account-popover' as popover_id %}
      <div
        class="account-popover__panel details-content color-{{ settings.popover_color_scheme }}"
        id="account-popover"
        popover="auto"
        ref="popover"
      >
        {% render 'whisper-account-actions' %}
      </div>
    </anchored-popover-component>

    <dialog-component
      class="account-drawer"
      {{ block.shopify_attributes }}
    >
      {% render 'whisper-account-button', attributes: 'on:click="/showDialog"' %}
      <dialog
        ref="dialog"
        class="color-{{ settings.popover_color_scheme }} dialog-modal dialog-drawer dialog-bottom-sheet account-drawer__dialog"
        scroll-lock
        aria-labelledby="account-drawer-heading"
      >
        <button
          ref="closeButton"
          on:click="/closeDialog"
          class="button button-unstyled close-button account-drawer__close-button"
          aria-label="{{ 'actions.close_dialog' | t }}"
          autofocus
        >
          <span
            class="svg-wrapper"
            aria-hidden="true"
          >
            {{- 'icon-close.svg' | inline_asset_content -}}
          </span>
        </button>
        {% render 'whisper-account-actions' %}
      </dialog>
    </dialog-component>
  {% endif %}

  {% if settings.cart_type == 'drawer' and template.name != 'cart' %}
    <script
      src="{{ 'cart-drawer.js' | asset_url }}"
      type="module"
      fetchpriority="low"
    ></script>

    <cart-drawer-component
      class="cart-drawer"
      {{ block.shopify_attributes }}
      {% if settings.auto_open_cart_drawer %}
        auto-open
      {% endif %}
    >
      <button
        class="button header-actions__action button-unstyled"
        on:click="/open"
        aria-haspopup="dialog"
        aria-label="{{ 'accessibility.cart' | t }}"
        aria-describedby="cart-bubble-text"
        data-testid="cart-drawer-trigger"
      >
        {{ cart_icon }}
      </button>

      <dialog
        ref="dialog"
        class="cart-drawer__dialog dialog-modal dialog-drawer color-{{ settings.drawer_color_scheme }}{% if cart.empty? %} cart-drawer--empty{%endif%}"
        aria-labelledby="{% if cart.empty? %}cart-drawer-heading-empty{% else %}cart-drawer-heading{% endif %}"
        scroll-lock
        cart-summary-sticky="true"
      >
        <div class="cart-drawer__inner">
          <cart-items-component
            class="cart-items-component"
            data-section-id="{{ section.id }}"
          >
            {%- if cart.empty? -%}
              <div class="cart-drawer__header">
                <button
                  ref="closeButton"
                  on:click="cart-drawer-component/close"
                  class="button close-button cart-drawer__close-button button-unstyled"
                  aria-label="{{ 'actions.close_dialog' | t }}"
                >
                  <span class="svg-wrapper">
                    {{- 'icon-close.svg' | inline_asset_content -}}
                  </span>
                </button>
              </div>

              <div
                class="cart-drawer__content motion-reduce"
                aria-label="{{ 'accessibility.cart' | t }}"
              >
                <h2
                  class="cart-drawer__heading h4 cart-drawer__heading--empty"
                  id="cart-drawer-heading-empty"
                >
                  {{ 'content.your_cart_is_empty' | t }}
                </h2>

                <div class="cart-drawer__items">
                  {% render 'whisper-cart-products', drawer_context: 'drawer' %}
                </div>
              </div>
            {%- else -%}
              <div
                class="cart-drawer__header"
                id="cart-drawer-header"
              >
                <h2
                  class="cart-drawer__heading h4"
                  id="cart-drawer-heading"
                >
                  {{ 'content.cart_title' | t }}
                  {% render 'whisper-cart-bubble' %}
                </h2>

                <button
                  ref="closeButton"
                  on:click="cart-drawer-component/close"
                  class="button close-button cart-drawer__close-button button-unstyled"
                  aria-label="{{ 'actions.close_dialog' | t }}"
                >
                  <span class="svg-wrapper">
                    {{- 'icon-close.svg' | inline_asset_content -}}
                  </span>
                </button>
              </div>

              <scroll-hint
                class="cart-drawer__content motion-reduce"
                aria-label="{{ 'accessibility.cart' | t }}"
                style="--header-height: 60px;"
              >
                <scroll-hint
                  class="cart-drawer__items"
                >
                  {% render 'whisper-cart-products', drawer_context: 'drawer' %}
                </scroll-hint>

                <div
                  class="cart-drawer__summary"
                >
                  {% render 'whisper-cart-summary' %}
                </div>
              </scroll-hint>
            {%- endif -%}
          </cart-items-component>
        </div>
      </dialog>
    </cart-drawer-component>
  {% else %}
    <a
      href="{{ routes.cart_url }}"
      class="header-actions__action action__cart"
      aria-label="{{ 'accessibility.cart' | t }}"
      aria-describedby="cart-bubble-text"
    >
      {{ cart_icon }}
    </a>
  {% endif %}
</header-actions>


