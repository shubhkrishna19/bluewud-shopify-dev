<div
  class="whisper-size-engine whisper-glass"
  data-size-engine
  data-product-handle="{{ product.handle }}"
>
  <button
    class="whisper-button whisper-size-engine__trigger"
    type="button"
    aria-haspopup="dialog"
  >
    Find my size
  </button>

  <div class="whisper-size-engine__modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="whisper-size-engine__dialog">
      <button class="whisper-size-engine__close" type="button" aria-label="Close size recommender">
        &times;
      </button>

      <h3 class="whisper-size-engine__title">Size Recommendation</h3>
      <p class="whisper-size-engine__subtitle">
        Share a few details and we will suggest the best fit for you.
      </p>

      <form class="whisper-size-engine__form">
        <label class="whisper-size-engine__field">
          <span>Height (cm)</span>
          <input name="height" type="number" min="120" max="220" placeholder="170" required>
        </label>

        <label class="whisper-size-engine__field">
          <span>Weight (kg)</span>
          <input name="weight" type="number" min="30" max="150" placeholder="70" required>
        </label>

        <label class="whisper-size-engine__field">
          <span>Fit preference</span>
          <select name="fit">
            <option value="snug">Snug</option>
            <option value="regular" selected>Regular</option>
            <option value="relaxed">Relaxed</option>
          </select>
        </label>

        <button class="whisper-button whisper-size-engine__submit" type="submit">
          Get recommendation
        </button>
      </form>

      <div class="whisper-size-engine__result" data-size-engine-result>
        Your recommendation will appear here.
      </div>
    </div>
  </div>
</div>

<script>
  (() => {
    const engines = document.querySelectorAll('[data-size-engine]');
    engines.forEach((engine) => {
      const handle = engine.dataset.productHandle || 'default';
      const modal = engine.querySelector('.whisper-size-engine__modal');
      const trigger = engine.querySelector('.whisper-size-engine__trigger');
      const closeButton = engine.querySelector('.whisper-size-engine__close');
      const form = engine.querySelector('.whisper-size-engine__form');
      const result = engine.querySelector('[data-size-engine-result]');
      const storageKey = `whisper:size-engine:${handle}`;

      const openModal = () => {
        modal.setAttribute('aria-hidden', 'false');
        modal.classList.add('is-active');
        const saved = window.localStorage.getItem(storageKey);
        if (saved) {
          const data = JSON.parse(saved);
          form.height.value = data.height || '';
          form.weight.value = data.weight || '';
          form.fit.value = data.fit || 'regular';
          result.textContent = data.recommendation
            ? `Recommended size: ${data.recommendation}`
            : 'Your recommendation will appear here.';
        }
      };

      const closeModal = () => {
        modal.setAttribute('aria-hidden', 'true');
        modal.classList.remove('is-active');
      };

      const getRecommendation = ({ height, weight, fit }) => {
        let size = 'Small';
        if (height >= 180 || weight >= 85) {
          size = 'Large';
        } else if (height >= 165 || weight >= 65) {
          size = 'Medium';
        }

        if (fit === 'relaxed' && size === 'Medium') {
          size = 'Large';
        }
        if (fit === 'snug' && size === 'Medium') {
          size = 'Small';
        }

        return size;
      };

      trigger.addEventListener('click', openModal);
      closeButton.addEventListener('click', closeModal);
      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const height = Number(form.height.value);
        const weight = Number(form.weight.value);
        const fit = form.fit.value;
        const recommendation = getRecommendation({ height, weight, fit });

        const payload = { height, weight, fit, recommendation };
        window.localStorage.setItem(storageKey, JSON.stringify(payload));
        result.textContent = `Recommended size: ${recommendation}`;
      });
    });
  })();
</script>
